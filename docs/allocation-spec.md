# 取引割当機能 仕様書

## 1. 概要
取引（Transaction）を予算項目（BudgetItem）に割り当てる機能。
1つの取引を複数の予算項目に分割して割り当てることができる。

## 2. 用語定義
- **取引（Transaction）**: freeeから同期された支出データ
- **予算項目（BudgetItem）**: 助成金の予算カテゴリ
- **割当（AllocationSplit）**: 取引と予算項目を紐付ける中間データ
- **割当額**: 取引金額のうち、特定の予算項目に割り当てる金額

## 3. ビジネスルール

### 3.1 基本ルール
- [ ] 1つの取引は複数の予算項目に分割可能
- [ ] 割当額の合計は取引金額を超えてはならない
- [ ] 割当額の合計は取引金額と一致する必要はない（部分割当を許可）
- [ ] 一度割り当てた後も編集・削除が可能

### 3.2 制約事項
- [ ] 削除された予算項目への割当は無効
- [ ] 割当額は0円以上の整数
- [ ] 同じ取引を同じ予算項目に重複して割り当てることは可能（複数行）

## 4. 画面要件

### 4.1 一覧画面（メイン）
**表示項目**
- 取引情報
  - [ ] 日付
  - [ ] 取引先
  - [ ] 勘定科目
  - [ ] 金額
  - [ ] 説明/備考
  - [ ] 割当状況（未割当/部分割当/完全割当）
  - [ ] 割当済み金額
  - [ ] 未割当金額

**フィルター機能**
- [ ] 期間（開始日〜終了日）
- [ ] 割当状況（未割当/部分割当/完全割当/すべて）
- [ ] 助成金で絞り込み
- [ ] 予算項目で絞り込み
- [ ] 金額範囲
- [ ] 取引先名（部分一致）

**ソート機能**
- [ ] 日付（昇順/降順）
- [ ] 金額（昇順/降順）
- [ ] 未割当金額（昇順/降順）

**アクション**
- [ ] 割当設定（モーダル表示）
- [ ] 一括割当（複数選択して同じ予算項目に割当）
- [ ] CSVエクスポート

### 4.2 割当設定モーダル
**表示内容**
- 取引詳細情報
- 現在の割当リスト（編集・削除可能）
- 新規割当追加フォーム

**入力項目**
- [ ] 予算項目（ドロップダウン）
  - 助成金名 - 予算項目名 の形式で表示
  - 残額も表示
- [ ] 割当額（数値入力）
  - 自動計算ボタン（残額を自動入力）
- [ ] 備考（テキスト）

**バリデーション**
- [ ] 割当額合計が取引金額を超えない
- [ ] 予算項目の残額を超える場合は警告表示（但し保存は可能）
- [ ] 必須項目チェック

### 4.3 割当履歴画面
**表示項目**
- [ ] 割当日時
- [ ] 取引情報
- [ ] 予算項目
- [ ] 割当額
- [ ] 操作者（将来実装）
- [ ] 備考

**フィルター**
- [ ] 期間
- [ ] 助成金
- [ ] 予算項目

## 5. データモデル

### AllocationSplit
```typescript
interface AllocationSplit {
  id: number;
  transactionId: number;  // 取引ID
  budgetItemId: number;   // 予算項目ID
  amount: number;         // 割当額
  note?: string;          // 備考
  createdAt: Date;        // 作成日時
  updatedAt: Date;        // 更新日時
}
```

### 取引の割当状態
```typescript
enum AllocationStatus {
  UNALLOCATED = 'unallocated',     // 未割当
  PARTIAL = 'partial',              // 部分割当
  FULL = 'full'                     // 完全割当
}
```

## 6. API設計

### エンドポイント
- `GET /api/allocations` - 割当一覧取得
- `POST /api/allocations` - 割当作成
- `PUT /api/allocations/:id` - 割当更新
- `DELETE /api/allocations/:id` - 割当削除
- `POST /api/allocations/bulk` - 一括割当
- `GET /api/allocations/export` - CSVエクスポート

## 7. ユーザーストーリー

### 基本フロー
1. ユーザーは取引一覧を表示する
2. 未割当の取引を選択する
3. 割当設定モーダルを開く
4. 予算項目と金額を入力する
5. 保存する
6. 一覧画面に戻り、割当状態が更新される

### 分割割当フロー
1. 10,000円の取引を選択
2. 予算項目A に 6,000円を割当
3. 予算項目B に 4,000円を割当
4. 保存して完全割当状態になる

### 編集フロー
1. 割当済みの取引を選択
2. 既存の割当を編集または削除
3. 新しい割当を追加
4. 保存

## 8. 非機能要件

### パフォーマンス
- [ ] 1000件の取引を3秒以内に表示
- [ ] フィルター適用は1秒以内
- [ ] 割当保存は2秒以内

### ユーザビリティ
- [ ] キーボードショートカット対応
- [ ] ドラッグ&ドロップでの割当（将来実装）
- [ ] 取り消し機能（Undo）

## 9. 実装優先度

### Phase 1（必須）
- [ ] 基本的な一覧表示
- [ ] 割当設定（作成・編集・削除）
- [ ] 基本的なフィルター

### Phase 2（推奨）
- [ ] 一括割当
- [ ] CSVエクスポート
- [ ] 詳細なフィルター

### Phase 3（将来）
- [ ] ドラッグ&ドロップ
- [ ] 割当テンプレート
- [ ] 自動割当提案（AI）

## 10. テストケース

### 基本テスト
- [ ] 単一割当の作成
- [ ] 分割割当の作成
- [ ] 割当の編集
- [ ] 割当の削除
- [ ] 金額超過時のエラー

### エッジケース
- [ ] 0円の割当
- [ ] 同じ予算項目への複数割当
- [ ] 削除された予算項目の扱い