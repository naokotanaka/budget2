// Prisma Schema for nagaiku-budget-v2
// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: PostgreSQL (é–‹ç™ºãƒ»æœ¬ç•ªåˆ‡ã‚Šæ›¿ãˆå¯¾å¿œ)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== å–å¼•ç®¡ç† ==========

model Transaction {
  id                   String            @id
  journalNumber        BigInt
  journalLineNumber    Int
  date                 DateTime
  description          String?
  amount               Int               // é‡‘é¡ï¼ˆå††å˜ä½ï¼‰
  account              String?           // å‹˜å®šç§‘ç›®
  supplier             String?           // å–å¼•å…ˆ
  item                 String?           // å–å¼•é …ç›®
  memo                 String?           // ãƒ¡ãƒ¢
  remark               String?           // å‚™è€ƒ
  department           String?           // éƒ¨é–€
  managementNumber     String?           // ç®¡ç†ç•ªå·
  freeDealId           BigInt?   @unique // freeeå–å¼•ID
  tags                 String?           // ãƒ¡ãƒ¢ã‚¿ã‚°
  detailDescription    String?           // æ˜ç´°å‚™è€ƒï¼ˆremarkã‹ã‚‰åˆ†é›¢ï¼‰  
  detailId             BigInt?           // æ˜ç´°IDï¼ˆè¡Œç•ªå·ï¼‰
  receiptIds           String?           // ãƒ¬ã‚·ãƒ¼ãƒˆIDé…åˆ—ï¼ˆJSONï¼‰
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  allocations          AllocationSplit[]

  @@map("transactions")
}

// ========== åŠ©æˆé‡‘ç®¡ç† ==========

model Grant {
  id           Int         @id @default(autoincrement())
  name         String      // åŠ©æˆé‡‘å
  grantCode    String?     // åŠ©æˆé‡‘ã‚³ãƒ¼ãƒ‰
  totalAmount  Int?        // ç·é¡ï¼ˆå††ï¼‰
  startDate    DateTime?   // é–‹å§‹æ—¥
  endDate      DateTime?   // çµ‚äº†æ—¥
  status       String      @default("active") // active, completed, applied
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  budgetItems  BudgetItem[]

  @@map("grants")
}

// ========== äºˆç®—é …ç›®ç®¡ç† ==========

model BudgetItem {
  id              Int               @id @default(autoincrement())
  name            String            // äºˆç®—é …ç›®å
  category        String?           // ã‚«ãƒ†ã‚´ãƒª
  budgetedAmount  Int?              // äºˆç®—é¡ï¼ˆå††ï¼‰
  note            String?           // ğŸ†• å‚™è€ƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  sortOrder       Int               @default(0) // ğŸ†• ä¸¦ã³é †
  grantId         Int               // åŠ©æˆé‡‘ID
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  grant           Grant             @relation(fields: [grantId], references: [id], onDelete: Cascade)
  allocations     AllocationSplit[]
  schedules       BudgetSchedule[]  // ğŸ†• æœˆåˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

  @@map("budget_items")
}

// ========== ğŸ†• äºˆç®—é …ç›®æœˆåˆ¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« ==========

model BudgetSchedule {
  id           Int        @id @default(autoincrement())
  budgetItemId Int        // äºˆç®—é …ç›®ID
  year         Int        // å¹´
  month        Int        // æœˆ (1-12)
  isActive     Boolean    @default(true)  // ãã®æœˆãŒæœ‰åŠ¹ã‹
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  budgetItem   BudgetItem @relation(fields: [budgetItemId], references: [id], onDelete: Cascade)

  @@unique([budgetItemId, year, month])
  @@map("budget_schedules")
}

// ========== ğŸ†• åˆ†å‰²å‰²å½“ï¼ˆ1å¯¾å¤šå¯¾å¿œï¼‰ ==========

model AllocationSplit {
  id             String      @id @default(cuid())
  transactionId  String      // å–å¼•ID
  budgetItemId   Int         // äºˆç®—é …ç›®ID
  amount         Int         // åˆ†å‰²é‡‘é¡ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰
  note           String?     // åˆ†å‰²ç†ç”±ãƒ»å‚™è€ƒ
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  transaction    Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  budgetItem     BudgetItem  @relation(fields: [budgetItemId], references: [id], onDelete: Cascade)

  @@map("allocation_splits")
}

// ========== freee APIé€£æº ==========

model FreeeToken {
  id           Int       @id @default(autoincrement())
  accessToken  String    @db.Text      // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆæš—å·åŒ–æ¨å¥¨ï¼‰
  refreshToken String    @db.Text      // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³
  expiresAt    DateTime                // æœ‰åŠ¹æœŸé™
  tokenType    String    @default("Bearer")  // ãƒˆãƒ¼ã‚¯ãƒ³ã‚¿ã‚¤ãƒ—
  scope        String?                 // èªå¯ã‚¹ã‚³ãƒ¼ãƒ—
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("freee_tokens")
}

// ========== ãƒ‡ãƒ¼ã‚¿åŒæœŸç®¡ç† ==========

model FreeeSync {
  id           Int       @id @default(autoincrement())
  lastSyncAt   DateTime                // æœ€çµ‚åŒæœŸæ—¥æ™‚
  syncStatus   String    @default("idle") // idle, running, success, error
  syncMessage  String?                 // åŒæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»ã‚¨ãƒ©ãƒ¼å†…å®¹
  recordCount  Int       @default(0)   // åŒæœŸãƒ¬ã‚³ãƒ¼ãƒ‰æ•°
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("freee_syncs")
}

// ========== ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãƒ»ã‚«ãƒ†ã‚´ãƒª ==========

model Category {
  id        Int      @id @default(autoincrement())
  name      String   @unique  // ã‚«ãƒ†ã‚´ãƒªå
  type      String             // transaction, budget_item, grant
  color     String?            // è¡¨ç¤ºè‰²
  sortOrder Int      @default(0)  // è¡¨ç¤ºé †åº
  isActive  Boolean  @default(true)  // æœ‰åŠ¹ãƒ»ç„¡åŠ¹
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

// ========== ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®š ==========

// æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
// Transaction
// - æ—¥ä»˜ã§ã®æ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆ
// - å‹˜å®šç§‘ç›®ã§ã®æ¤œç´¢
// - freeeå–å¼•IDã§ã®æ¤œç´¢

// AllocationSplit  
// - å–å¼•IDã§ã®æ¤œç´¢ï¼ˆ1å¯¾å¤šå‚ç…§ï¼‰
// - äºˆç®—é …ç›®IDã§ã®æ¤œç´¢

// BudgetSchedule
// - å¹´æœˆã§ã®æ¤œç´¢
// - äºˆç®—é …ç›®IDã§ã®æ¤œç´¢