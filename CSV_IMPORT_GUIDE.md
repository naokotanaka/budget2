# CSVインポート機能ガイド

nagaiku-budget-v2システムのCSVインポート機能の使用方法について説明します。

## 機能概要

- **UTF-8 BOM対応**: UTF-8 BOMファイルの自動処理
- **文字コード自動検出**: UTF-8、Shift_JIS、UTF-16の自動検出
- **日本語ファイル名対応**: 日本語ファイル名の正しい処理
- **データバリデーション**: インポート前のデータ検証
- **リアルタイムプレビュー**: インポート前のデータ確認
- **エラーハンドリング**: 詳細なエラー情報と修正提案

## 対応データ形式

### 1. 助成金データ

**必須フィールド**:
- 助成金名（name）

**オプションフィールド**:
- 助成金コード（grantCode）
- 総額（totalAmount）- 数値、円単位
- 開始日（startDate）- YYYY-MM-DD形式
- 終了日（endDate）- YYYY-MM-DD形式  
- 状態（status）- in_progress/completed/reported

**CSVサンプル**:
```csv
助成金名,助成金コード,総額,開始日,終了日,状態
令和5年度地域活動支援事業,R5-CHIIKI-001,1000000,2023-04-01,2024-03-31,in_progress
高齢者福祉向上プロジェクト,KOUREISHA-2023,2500000,2023-06-01,2024-05-31,in_progress
```

### 2. 予算項目データ

**必須フィールド**:
- 項目名（name）

**オプションフィールド**:
- カテゴリ（category）
- 予算額（budgetedAmount）- 数値、円単位
- 備考（note）
- 助成金名（grantName）- 関連付けする助成金の名称

**CSVサンプル**:
```csv
項目名,カテゴリ,予算額,備考,助成金名
会議費,運営費,50000,月次会議用,令和5年度地域活動支援事業
研修費,人材育成,200000,スタッフ研修,令和5年度地域活動支援事業
設備費,施設整備,800000,新規機材購入,高齢者福祉向上プロジェクト
```

## 使用方法

### 1. 助成金データのインポート

1. 助成金管理ページにアクセス
2. 「CSVインポート」ボタンをクリック
3. CSVファイルをドラッグ&ドロップまたはファイル選択
4. プレビューでデータを確認
5. 「インポート」ボタンでデータを取り込み

### 2. 予算項目データのインポート

1. 予算項目管理ページにアクセス
2. 「CSVインポート」ボタンをクリック
3. CSVファイルをドラッグ&ドロップまたはファイル選択
4. プレビューでデータを確認
5. 「インポート」ボタンでデータを取り込み

**注意**: 予算項目をインポートする前に、関連する助成金が既に登録されている必要があります。

## データバリデーション

### 助成金データ
- **助成金名**: 必須、空文字不可
- **総額**: 数値、0以上
- **日付**: 有効な日付形式（YYYY-MM-DD、YYYY/MM/DD、YYYY年MM月DD日）
- **状態**: 有効な値（進行中、完了、終了、reported等）

### 予算項目データ
- **項目名**: 必須、空文字不可
- **予算額**: 数値、0以上
- **助成金名**: 既存の助成金と一致する名称

## エラー処理

### 一般的なエラー
- **文字化け**: 文字コード自動検出により解決
- **BOM問題**: UTF-8 BOMの自動除去
- **空行**: 自動的にスキップ
- **カンマエスケープ**: 引用符内のカンマを正しく処理

### バリデーションエラー
- **必須フィールド不足**: 該当行と不足フィールドを表示
- **数値形式エラー**: 修正すべき値を表示
- **日付形式エラー**: 正しい形式を提案
- **重複データ**: 既存データとの重複を警告

## API仕様

### 助成金インポート
- **エンドポイント**: `POST /api/grants/import`
- **Content-Type**: `application/json`
- **Request Body**:
```json
{
  "data": [
    {
      "name": "助成金名",
      "grantCode": "助成金コード",
      "totalAmount": 1000000,
      "startDate": "2023-04-01",
      "endDate": "2024-03-31",
      "status": "in_progress"
    }
  ]
}
```

### 予算項目インポート
- **エンドポイント**: `POST /api/budget-items/import`
- **Content-Type**: `application/json`
- **Request Body**:
```json
{
  "data": [
    {
      "name": "項目名",
      "category": "カテゴリ",
      "budgetedAmount": 50000,
      "note": "備考",
      "grantName": "助成金名"
    }
  ]
}
```

### レスポンス形式
```json
{
  "success": true,
  "message": "インポート完了: 成功 5 件, エラー 0 件",
  "summary": {
    "total": 5,
    "success": 5,
    "errors": 0
  },
  "data": [...],
  "errors": []
}
```

## トラブルシューティング

### よくある問題

1. **文字化けする**
   - ファイルの文字コードを確認
   - UTF-8またはShift_JISで保存し直す

2. **日付が認識されない**  
   - YYYY-MM-DD形式に変更
   - 全角文字を半角文字に変更

3. **数値が認識されない**
   - 全角数字を半角数字に変更
   - カンマやスペースを除去

4. **助成金が見つからない**
   - 助成金名が正確に一致しているか確認
   - 先に助成金をインポートしてから予算項目をインポート

5. **インポートが失敗する**
   - ファイルサイズを確認（推奨: 10MB以下）
   - ブラウザのコンソールでエラーメッセージを確認

## ファイル形式の推奨事項

- **文字コード**: UTF-8（BOM付きでも可）
- **改行コード**: LF または CRLF
- **区切り文字**: カンマ（,）
- **引用符**: ダブルクォート（"）でフィールドを囲む
- **ファイルサイズ**: 10MB以下
- **行数**: 10,000行以下（推奨）

## セキュリティ考慮事項

- アップロードファイルは一時的に処理され、処理後に削除されます
- SQLインジェクション対策済み
- XSS対策済み
- ファイルタイプ検証実装済み

この機能を使用して効率的にデータをインポートし、助成金管理業務を効率化してください。