# nagaiku-budget ã‹ã‚‰ nagaiku-budget-v2 ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ¬ãƒãƒ¼ãƒˆ

## å®Ÿæ–½æ¦‚è¦
- **å®Ÿæ–½æ—¥æ™‚**: 2025-08-22
- **ç§»è¡Œå…ƒ**: nagaiku_budgetï¼ˆç¾è¡Œã‚·ã‚¹ãƒ†ãƒ ï¼‰
- **ç§»è¡Œå…ˆ**: nagaiku_budget_v2_prodï¼ˆæ–°ã‚·ã‚¹ãƒ†ãƒ ï¼‰
- **ç§»è¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æˆåŠŸ

## ç§»è¡Œçµæœã‚µãƒãƒªãƒ¼

| ãƒ†ãƒ¼ãƒ–ãƒ« | ç§»è¡Œä»¶æ•° | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|----------|----------|------------|
| categories | 12ä»¶ | âœ… å®Œäº† |
| grants | 8ä»¶ | âœ… å®Œäº† |
| budget_items | 27ä»¶ | âœ… å®Œäº† |
| transactions | 582ä»¶ | âœ… å®Œäº† |
| allocation_splits | 221ä»¶ | âœ… å®Œäº† |

## ä¸»è¦ãªå¤‰æ›´ç‚¹

### 1. ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´
- **allocations** â†’ **allocation_splits** ãƒ†ãƒ¼ãƒ–ãƒ«åå¤‰æ›´
- å‰²å½“ãƒ‡ãƒ¼ã‚¿ã« `detailId` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã€å–å¼•ã¨ã®æ–°ã—ã„é–¢é€£ä»˜ã‘ã‚’å®Ÿè£…
- `freeDealId` ã®UNIQUEåˆ¶ç´„ã‚’å‰Šé™¤ï¼ˆé‡è¤‡ãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼‰

### 2. detailIdã®ä»˜ä¸ãƒ­ã‚¸ãƒƒã‚¯
```javascript
detailId = journal_number * 100 + journal_line_number
```
- ä¾‹: journal_number=5070202, journal_line_number=1 â†’ detailId=507020201
- å…¨582ä»¶ã®å–å¼•ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªdetailIdãŒæ­£å¸¸ã«ç”Ÿæˆãƒ»é©ç”¨

### 3. æ—¥ä»˜å‹ã®å¤‰æ›
- **æ—§ã‚·ã‚¹ãƒ†ãƒ **: DATEå‹
- **æ–°ã‚·ã‚¹ãƒ†ãƒ **: DATETIMEå‹
- å¤‰æ›ãƒ«ãƒ¼ãƒ«:
  - start_date â†’ 00:00:00ã«è¨­å®š
  - end_date â†’ 23:59:59ã«è¨­å®š
  - transaction date â†’ 12:00:00ã«è¨­å®š

### 4. æ–°è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ 
- **grants**: createdAt, updatedAt
- **budget_items**: sortOrder, createdAt, updatedAt
- **categories**: type, color, sortOrder
- **transactions**: detailDescription, receiptIds, tags
- **allocation_splits**: note, updatedAt

## ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯çµæœ

### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•´åˆæ€§
âœ… **budget_items â†’ grants**: æ•´åˆæ€§OKï¼ˆå­¤ç«‹ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰
âœ… **allocation_splits â†’ budget_items**: æ•´åˆæ€§OKï¼ˆå­¤ç«‹ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰
âœ… **allocation_splits â†’ transactions**: æ•´åˆæ€§OKï¼ˆå­¤ç«‹ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰

### ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚µãƒ³ãƒ—ãƒ«

#### åŠ©æˆé‡‘åˆ¥äºˆç®—é …ç›®ã¨å‰²å½“çŠ¶æ³
```
grant_name    | budget_item_name      | allocation_count | total_allocated
WAMè£œ         | æ¶ˆè€—å“è²»              | 68               | 327,625å††
WAMè£œ         | è³ƒé‡‘ï¼ˆã‚¢ãƒ«ãƒã‚¤ãƒˆï¼‰    | 20               | 695,126å††
WAMè£œ         | å®¶è³ƒ                  | 2                | 301,600å††
ã¤ãªãŒã‚Š10    | é£Ÿæè²»                | 18               | 222,682å††
ã‚€ã™æ˜¥        | é£Ÿå“è³¼å…¥è²»            | 8                | 48,120å††
```

#### å–å¼•ã¨å‰²å½“ã®é–¢é€£ç¢ºèª
- detailIdã«ã‚ˆã‚‹é–¢é€£ä»˜ã‘ãŒæ­£å¸¸ã«å‹•ä½œ
- å–å¼•é‡‘é¡ã¨å‰²å½“é‡‘é¡ã®æ•´åˆæ€§ç¢ºèªæ¸ˆã¿

## è§£æ±ºã—ãŸå•é¡Œ

### 1. æ—¥ä»˜å¤‰æ›ã‚¨ãƒ©ãƒ¼
- **å•é¡Œ**: PostgreSQLã‹ã‚‰è¿”ã•ã‚Œã‚‹æ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸é©åˆ‡ãªæ–‡å­—åˆ—çµåˆ
- **è§£æ±º**: JavaScriptã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç›´æ¥ä½¿ç”¨ã—ã€setHours()ã§æ™‚åˆ»è¨­å®š

### 2. freeDealIdé‡è¤‡ã‚¨ãƒ©ãƒ¼
- **å•é¡Œ**: ç¾è¡Œã‚·ã‚¹ãƒ†ãƒ ã§åŒä¸€freeeå–å¼•IDãŒè¤‡æ•°ã®ä»•è¨³è¡Œã«å­˜åœ¨
- **è§£æ±º**: Prismaã‚¹ã‚­ãƒ¼ãƒã®freeDealId UNIQUEåˆ¶ç´„ã‚’å‰Šé™¤

### 3. ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å¯¾å¿œ
- **å•é¡Œ**: package.jsonã®"type": "module"è¨­å®šã«ã‚ˆã‚‹requireæ§‹æ–‡ã‚¨ãƒ©ãƒ¼
- **è§£æ±º**: importæ§‹æ–‡ã¨ES Moduleå½¢å¼ã«å¤‰æ›´

## ç§»è¡Œå¾Œã®ç¢ºèªäº‹é …

### âœ… å®Œäº†æ¸ˆã¿
- [ ] å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä»¶æ•°ç¢ºèª
- [ ] ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
- [ ] ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡ºç¢ºèª
- [ ] detailIdã®ä¸€æ„æ€§ç¢ºèª
- [ ] å‰²å½“é‡‘é¡ã®é›†è¨ˆç¢ºèª

### ğŸ“‹ ä»Šå¾Œã®ä½œæ¥­
- [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã®å‹•ä½œç¢ºèª
- [ ] freeeé€£æºæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼å—ã‘å…¥ã‚Œãƒ†ã‚¹ãƒˆ
- [ ] æœ¬ç•ªé‹ç”¨é–‹å§‹

## ä½¿ç”¨ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«
- `/home/tanaka/projects/nagaiku-budget-v2/migration/migrate-data.js` - ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `/home/tanaka/projects/nagaiku-budget-v2/migration/schema-mapping.md` - ã‚¹ã‚­ãƒ¼ãƒãƒãƒƒãƒ”ãƒ³ã‚°
- `/home/tanaka/projects/nagaiku-budget-v2/prisma/schema.prisma` - æ–°ã‚·ã‚¹ãƒ†ãƒ ã‚¹ã‚­ãƒ¼ãƒ

## å®Ÿè¡Œæ–¹æ³•
```bash
# DRY-RUNï¼ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼‰
node migration/migrate-data.js --dry-run --verbose

# æœ¬ç•ªå®Ÿè¡Œ
node migration/migrate-data.js

# è©³ç´°ãƒ­ã‚°ä»˜ãå®Ÿè¡Œ
node migration/migrate-data.js --verbose
```

## å‚™è€ƒ
- ç§»è¡Œä¸­ã«ç¾è¡Œã‚·ã‚¹ãƒ†ãƒ ã‚’åœæ­¢ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“
- ç§»è¡Œå…ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯å®Œå…¨ã«ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰ç§»è¡Œã‚’å®Ÿè¡Œ
- ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡ŒãŒæ­£å¸¸å®Œäº†ã—ã€æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚‚ã™ã¹ã¦ãƒ‘ã‚¹
- æ–°ã‚·ã‚¹ãƒ†ãƒ ã§ã®é‹ç”¨æº–å‚™ãŒæ•´ã„ã¾ã—ãŸ

---
**ç§»è¡Œè²¬ä»»è€…**: Claude Code Assistant  
**ç§»è¡Œå®Œäº†æ—¥æ™‚**: 2025-08-22