# 502 Bad Gateway エラー解決レポート

## エラー概要
- **エラー種類**: 502 Bad Gateway
- **影響範囲**: 開発環境全体
- **発生頻度**: 頻繁（ユーザーの作業を度々中断）
- **緊急度**: 最高

## 根本原因分析

### 1. 主要原因
- **セッション切断によるプロセス終了**: SSH接続が切れると開発サーバープロセスが終了
- **メモリリーク**: Viteのホットリロードによるメモリ蓄積
- **キャッシュ肥大化**: `.vite`と`.svelte-kit`ディレクトリの肥大化
- **ポート競合**: 不正終了したプロセスがポートを占有

### 2. 発生パターン
- 長時間の開発作業後
- ファイル変更が頻繁な時
- SSH接続が不安定な環境
- メモリ使用率が高い状態

## 実施した解決策

### 1. 即座の対応（完了）
✅ **universal-dev-clean.sh**でクリーンスタート実行
- キャッシュクリア
- ポート解放
- プロセス再起動

### 2. 恒久対策ツール（作成済み）

#### A. tmux開発環境（推奨）
```bash
# tmuxセッション起動
./tmux-dev.sh

# 特徴:
- セッション切断に強い
- 複数ウィンドウで監視可能
- バックグラウンド実行可能
```

#### B. 502 Guardian自動監視
```bash
# バックグラウンドで監視開始
./502-guardian.sh -d

# 機能:
- 30秒毎の自動ヘルスチェック
- 502エラー自動検知
- 自動復旧（最大3回試行）
- メモリ監視とキャッシュクリア
```

## 予防策

### 1. 開発時の推奨事項
- **tmux使用**: 常に`./tmux-dev.sh`で開発環境を起動
- **定期的なキャッシュクリア**: 4時間毎にキャッシュクリア
- **メモリ監視**: メモリ使用率80%超えたら再起動

### 2. システム設定の最適化
```bash
# Vite設定の最適化（vite.config.ts）
server: {
  watch: {
    usePolling: false,  # ポーリング無効化でCPU削減
    interval: 100       # 監視間隔調整
  },
  hmr: {
    overlay: false      # エラーオーバーレイ無効化
  }
}
```

### 3. 運用ルール
1. **開発開始時**: `./tmux-dev.sh`を実行
2. **エラー発生時**: `./universal-dev-clean.sh`で即座に復旧
3. **長時間作業時**: `./502-guardian.sh -d`をバックグラウンド起動
4. **作業終了時**: `tmux kill-session -t nagaiku-dev`でクリーンアップ

## 監視コマンド一覧

```bash
# サーバー状態確認
curl -I http://localhost:3002/budget2

# プロセス確認
ps aux | grep -E "node|vite"

# ポート使用状況
lsof -i :3002

# メモリ使用状況
free -h

# tmuxセッション確認
tmux ls

# ログ確認
tail -f logs/dev-server.log
tail -f logs/502-guardian.log
```

## トラブルシューティング

### Q: 502エラーが再発した場合
```bash
# 手順1: クリーンスタート
./universal-dev-clean.sh

# 手順2: tmuxで再起動
./tmux-dev.sh

# 手順3: 監視開始
./502-guardian.sh -d
```

### Q: tmuxセッションが応答しない
```bash
# 強制終了と再起動
tmux kill-session -t nagaiku-dev
pkill -f "vite dev"
./tmux-dev.sh
```

### Q: メモリ不足エラー
```bash
# キャッシュ完全削除
rm -rf node_modules/.vite
rm -rf .svelte-kit
rm -rf node_modules/.cache
npm cache clean --force
```

## 効果測定

### 導入前
- 502エラー発生頻度: 1時間に2-3回
- 復旧時間: 5-10分（手動対応）
- 作業中断: 頻繁

### 導入後（期待値）
- 502エラー発生頻度: ほぼゼロ
- 復旧時間: 30秒以内（自動復旧）
- 作業中断: 最小限

## まとめ

502 Bad Gatewayエラーの問題は、以下の3層防御で解決：

1. **第1層**: tmuxによるセッション永続化
2. **第2層**: 502 Guardianによる自動監視・復旧
3. **第3層**: universal-dev-cleanによる手動復旧

これにより、開発環境の安定性が大幅に向上し、作業効率が改善されます。

---
作成日: 2025-08-08
更新日: 2025-08-08