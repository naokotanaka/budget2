<script lang="ts">
  import { onMount, onDestroy, createEventDispatcher } from 'svelte';
  import { TabulatorFull as Tabulator } from 'tabulator-tables';
  import type { ColumnDefinition } from 'tabulator-tables';
  import 'tabulator-tables/dist/css/tabulator.min.css';
  import type { Grant, BudgetItem, BudgetItemSchedule } from '$lib/types/models';

  // Props
  export let budgetItems: BudgetItem[] = [];
  export let grants: Grant[] = [];
  export let selectedGrant: Grant | null = null;
  export let showMonthlyBudget: boolean = true;
  export let showMonthlyUsed: boolean = true;
  export let showMonthlyRemaining: boolean = true;
  export let monthFilterStartYear: number = 2025;
  export let monthFilterStartMonth: number = 1;
  export let monthFilterEndYear: number = 2025;
  export let monthFilterEndMonth: number = 12;
  export let budgetItemSchedules: Map<number, {months: string[], scheduleData: Map<string, {monthlyBudget: number}>}> = new Map();
  export let schedulesLoaded: boolean = false;

  // Event dispatcher
  const dispatch = createEventDispatcher();

  // Local variables
  let tableElement: HTMLDivElement;
  let table: Tabulator | null = null;
  let columns: ColumnDefinition[] = [];
  let baseColumns: ColumnDefinition[] = [];
  let tableData: any[] = [];
  let monthColumns: Array<{year: number, month: number, label: string}> = [];
  let isTableInitializing = false;
  let isTableUpdating = false;
  let lastDisplaySettings = {
    showMonthlyBudget: true,
    showMonthlyUsed: true,
    showMonthlyRemaining: true,
    monthFilterStartYear: 2025,
    monthFilterStartMonth: 1,
    monthFilterEndYear: 2025,
    monthFilterEndMonth: 12
  };

  // Reactive updates
  $: if (budgetItems && grants) {
    monthColumns = generateMonthColumns(grants, selectedGrant, budgetItems);
  }

  $: if (tableElement && budgetItems.length > 0 && monthColumns.length > 0 && !isTableUpdating) {
    // console.log('üîÑ „ÉÜ„Éº„Éñ„É´Ë¶ÅÁ¥†Ê∫ñÂÇôÂÆå‰∫Ü„ÄÅÊõ¥Êñ∞ÈñãÂßã:', {
    //   tableElement: !!tableElement,
    //   budgetItems: budgetItems.length,
    //   monthColumns: monthColumns.length,
    //   tableExists: !!table,
    //   isTableUpdating
    // });
    handleTableUpdate();
  }

  // Handle display settings changes
  $: {
    const currentSettings = {
      showMonthlyBudget,
      showMonthlyUsed,
      showMonthlyRemaining,
      monthFilterStartYear,
      monthFilterStartMonth,
      monthFilterEndYear,
      monthFilterEndMonth
    };
    
    if (table && JSON.stringify(currentSettings) !== JSON.stringify(lastDisplaySettings)) {
      handleDisplaySettingsChange(currentSettings);
    }
  }

  // Helper functions
  function formatAmount(amount?: number, includeYen: boolean = true): string {
    if (amount == null || amount === undefined) return includeYen ? '¬•0' : '0';
    const formatted = amount.toLocaleString();
    return includeYen ? `¬•${formatted}` : formatted;
  }

  function calculateMonthlyTotals(rowData: any) {
    const settings = {
      showMonthlyBudget,
      showMonthlyUsed,
      showMonthlyRemaining
    };

    let totalBudget = 0;
    let totalUsed = 0;
    let totalRemaining = 0;

    const filteredMonths = getFilteredMonthColumns();
    
    filteredMonths.forEach(monthCol => {
      const monthlyBudget = getMonthlyAmount(rowData, monthCol.year, monthCol.month);
      const monthKey = `${monthCol.year}-${monthCol.month.toString().padStart(2, '0')}`;
      const monthlyUsed = rowData.monthlyUsedAmounts?.[monthKey] || 0;
      const monthlyRemaining = monthlyBudget - monthlyUsed;

      if (settings.showMonthlyBudget) totalBudget += monthlyBudget;
      if (settings.showMonthlyUsed) totalUsed += monthlyUsed;
      if (settings.showMonthlyRemaining) totalRemaining += monthlyRemaining;
    });

    return {
      totalBudget,
      totalUsed,
      totalRemaining
    };
  }

  function generateMonthColumns(grantsData: Grant[], selectedGrantData: Grant | null, currentBudgetItems: any[]): Array<{year: number, month: number, label: string}> {
    // console.log('generateMonthColumns called, grants.length:', grantsData?.length, 'budgetItems.length:', currentBudgetItems?.length);
    
    if (selectedGrantData) {
      // ÈÅ∏Êäû„Åï„Çå„ÅüÂä©ÊàêÈáë„ÅÆÊúüÈñì„Åã„ÇâÁîüÊàê
      if (selectedGrantData.startDate && selectedGrantData.endDate) {
        const start = new Date(selectedGrantData.startDate);
        const end = new Date(selectedGrantData.endDate);
        const months = [];
        
        const current = new Date(start);
        while (current <= end) {
          months.push({
            year: current.getFullYear(),
            month: current.getMonth() + 1,
            label: `${current.getFullYear()}/${(current.getMonth() + 1).toString().padStart(2, '0')}`
          });
          current.setMonth(current.getMonth() + 1);
        }
        
        // console.log('Selected grant months:', months);
        return months;
      }
      // console.log('Selected grant has no date range');
      return [];
    }
    
    // ‰∫àÁÆóÈ†ÖÁõÆ„Å´Èñ¢ÈÄ£„Åô„ÇãÂä©ÊàêÈáë„Åã„ÇâÊúüÈñì„ÇíÂèéÈõÜ
    const relevantGrants = new Set<number>();
    currentBudgetItems.forEach(item => {
      if (item.grantId) {
        relevantGrants.add(item.grantId);
      }
    });
    
    // console.log('Relevant grant IDs:', Array.from(relevantGrants));
    
    const months: Array<{year: number, month: number, label: string}> = [];
    const uniqueMonths = new Set<string>();
    
    // Èñ¢ÈÄ£„Åô„ÇãÂä©ÊàêÈáë„ÅÆÊúüÈñì„Åã„ÇâÊúà„ÇíÁîüÊàê
    grantsData.forEach(grant => {
      if (!relevantGrants.has(grant.id)) return;
      
      if (grant.startDate && grant.endDate) {
        const start = new Date(grant.startDate);
        const end = new Date(grant.endDate);
        
        const current = new Date(start);
        while (current <= end) {
          const monthKey = `${current.getFullYear()}-${current.getMonth() + 1}`;
          if (!uniqueMonths.has(monthKey)) {
            uniqueMonths.add(monthKey);
            months.push({
              year: current.getFullYear(),
              month: current.getMonth() + 1,
              label: `${current.getFullYear()}/${(current.getMonth() + 1).toString().padStart(2, '0')}`
            });
          }
          current.setMonth(current.getMonth() + 1);
        }
      }
    });
    
    // ÊôÇÁ≥ªÂàó„Åß„ÇΩ„Éº„Éà
    months.sort((a, b) => {
      if (a.year !== b.year) return a.year - b.year;
      return a.month - b.month;
    });
    
    // console.log('Generated month columns:', months.length);
    return months;
  }

  function getFilteredMonthColumns() {
    // console.log('üîç getFilteredMonthColumns ÈñãÂßã:', {
    // monthColumnsExists: !!monthColumns,
    // monthColumnsLength: monthColumns?.length || 0,
    // monthFilterStartYear,
    // monthFilterStartMonth,
    // monthFilterEndYear,
    // monthFilterEndMonth
    // });
    
    if (!monthColumns || monthColumns.length === 0) {
      // console.log('üîç ÊúàÂàó„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
      return [];
    }
    
    const filtered = monthColumns.filter(col => {
      const colDate = col.year * 100 + col.month;
      const startDate = monthFilterStartYear * 100 + monthFilterStartMonth;
      const endDate = monthFilterEndYear * 100 + monthFilterEndMonth;
      
      const isInRange = colDate >= startDate && colDate <= endDate;
      
      if (!isInRange) {
        // console.log(`üîç Èô§Â§ñ: ${col.year}/${col.month} (${colDate} < ${startDate} || ${colDate} > ${endDate})`);
      }
      
      return isInRange;
    });
    
    // console.log('üîç „Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÁµêÊûú:', {
    // original: monthColumns.length,
    // filtered: filtered.length,
    // firstFiltered: filtered[0],
    // lastFiltered: filtered[filtered.length - 1]
    // });
    
    return filtered;
  }

  function getMonthlyAmount(item: any, targetYear: number, targetMonth: number): number {
    const schedules = budgetItemSchedules.get(item.id);
    const monthKey = `${targetYear.toString().slice(-2)}/${targetMonth.toString().padStart(2, '0')}`;
    
    // console.log(`üí∞ getMonthlyAmountÂëº„Å≥Âá∫„Åó: È†ÖÁõÆID${item.id} ${monthKey}Êúà`, {
    // schedules,
    // budgetedAmount: item.budgetedAmount,
    // schedulesLoaded,
    // budgetItemSchedulesSize: budgetItemSchedules.size,
    // schedulesExists: !!schedules,
    // schedulesMonthsExists: !!schedules?.months,
    // scheduleDataExists: !!schedules?.scheduleData,
    // scheduleDataHasKey: schedules?.scheduleData?.has(monthKey)
    // });
    
    // „Çπ„Ç±„Ç∏„É•„Éº„É´„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„ÇíÂÑ™ÂÖà
    if (schedules && schedules.scheduleData && schedules.scheduleData.has(monthKey)) {
      const monthData = schedules.scheduleData.get(monthKey);
      // console.log(`‚úÖ „Çπ„Ç±„Ç∏„É•„Éº„É´„Éá„Éº„Çø‰ΩøÁî®: ${monthData?.monthlyBudget || 0}`);
      return monthData?.monthlyBudget || 0;
    }
    
    // ÈÅ∏Êäû„Åï„Çå„ÅüÊúà„Å†„Åë„Å´‰∫àÁÆó„ÇíÈÖçÂàÜ
    if (schedules && schedules.months && schedules.months.length > 0) {
      const isSelectedMonth = schedules.months.includes(monthKey);
      if (isSelectedMonth) {
        const monthlyAmount = Math.floor((item.budgetedAmount || 0) / schedules.months.length);
        // console.log(`üìä ÈÅ∏ÊäûÊúà„Å´ÂùáÁ≠âÈÖçÂàÜ: ${monthlyAmount} (${item.budgetedAmount} / ${schedules.months.length})`);
        return monthlyAmount;
      } else {
        // console.log(`‚è≠Ô∏è ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÊúà: 0`);
        return 0;
      }
    }
    
    // „Çπ„Ç±„Ç∏„É•„Éº„É´„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÂä©ÊàêÈáëÊúüÈñìÂÖ®‰Ωì„ÅßÂùáÁ≠âÈÖçÂàÜ
    if (!schedulesLoaded) {
      const grant = grants.find(g => g.id === item.grantId);
      if (grant && grant.startDate && grant.endDate) {
        const start = new Date(grant.startDate);
        const end = new Date(grant.endDate);
        
        const targetDate = new Date(targetYear, targetMonth - 1);
        if (targetDate >= start && targetDate <= end) {
          const monthsDiff = (end.getFullYear() - start.getFullYear()) * 12 + 
                           (end.getMonth() - start.getMonth()) + 1;
          const monthlyAmount = Math.floor((item.budgetedAmount || 0) / monthsDiff);
          // console.log(`üìà Âä©ÊàêÈáëÊúüÈñì„ÅßÂùáÁ≠âÈÖçÂàÜ: ${monthlyAmount}`);
          return monthlyAmount;
        }
      }
    }
    
    // console.log(`‚ùå ÊúàÂà•ÈáëÈ°ç„Å™„Åó: 0`);
    return 0;
  }

  function initializeTableColumns() {
    // console.log('üîß initializeTableColumns Âëº„Å≥Âá∫„ÅóÈñãÂßã!');
    
    // Âü∫Êú¨Âàó„ÇíÂõ∫ÂÆö„ÅßÂÆöÁæ©
    const fixedBaseColumns = [
      {
        title: "Âä©ÊàêÈáë",
        field: "grantName",
        frozen: true,
        minWidth: 120,
        width: 180,
        widthGrow: 1,
        sorter: "string"
      },
      {
        title: "È†ÖÁõÆÂêç", 
        field: "name",
        frozen: true,
        width: 220,
        minWidth: 150,
        widthGrow: 2,
        sorter: "string"
      },
      {
        title: "„Ç´„ÉÜ„Ç¥„É™",
        field: "category",
        width: 120,
        minWidth: 100,
        widthGrow: 0.5,
        sorter: "string"
      },
      {
        title: "‰∫àÁÆóÈ°ç",
        field: "budgetedAmount",
        width: 130,
        minWidth: 110,
        widthGrow: 0.8,
        sorter: "number",
        hozAlign: "right",
        formatter: (cell) => {
          const budgetedAmount = cell.getValue();
          const rowData = cell.getRow().getData();
          const monthlyTotals = calculateMonthlyTotals(rowData);
          
          return `
            <div style="font-size: 11px; line-height: 1.3;">
              <div style="margin-bottom: 2px;">${formatAmount(budgetedAmount)}</div>
              <div style="color: #6b7280; font-size: 10px;">ÊúàË®à: ${formatAmount(monthlyTotals.totalBudget, false)}</div>
            </div>
          `;
        }
      },
      {
        title: "‰ΩøÁî®È°ç",
        field: "usedAmount",
        width: 130,
        minWidth: 110,
        widthGrow: 0.8,
        sorter: "number",
        hozAlign: "right",
        formatter: (cell) => {
          const usedAmount = cell.getValue();
          const rowData = cell.getRow().getData();
          const monthlyTotals = calculateMonthlyTotals(rowData);
          
          return `
            <div style="font-size: 11px; line-height: 1.3;">
              <div style="margin-bottom: 2px;">${formatAmount(usedAmount)}</div>
              <div style="color: #6b7280; font-size: 10px;">ÊúàË®à: ${formatAmount(monthlyTotals.totalUsed, false)}</div>
            </div>
          `;
        }
      },
      {
        title: "ÊÆãÈ°ç",
        field: "remainingAmount",
        width: 130,
        minWidth: 110,
        widthGrow: 0.8,
        sorter: "number",
        hozAlign: "right",
        formatter: (cell) => {
          const value = cell.getValue();
          const color = value < 0 ? 'red' : 'green';
          const rowData = cell.getRow().getData();
          const monthlyTotals = calculateMonthlyTotals(rowData);
          const monthColor = monthlyTotals.totalRemaining < 0 ? 'red' : '#6b7280';
          
          return `
            <div style="font-size: 11px; line-height: 1.3;">
              <div style="color: ${color}; font-weight: 600; margin-bottom: 2px;">${formatAmount(value)}</div>
              <div style="color: ${monthColor}; font-size: 10px;">ÊúàË®à: ${formatAmount(monthlyTotals.totalRemaining, false)}</div>
            </div>
          `;
        }
      }
    ];
    
    // Âü∫Êú¨Âàó„ÇíË®≠ÂÆö
    baseColumns = [...fixedBaseColumns];
    
    // ÊúàÂàó„ÇíÂãïÁöÑ„Å´ÊßãÁØâ
    const monthColumnDefs = [];
    // console.log('üîß ÊúàÂàóÊßãÁØâÈñãÂßã:', {
    // monthColumnsLength: monthColumns?.length || 0
    // });
    
    if (monthColumns && monthColumns.length > 0) {
      // Êúà„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„ÇíÈÅ©Áî®
      const filteredMonthColumns = getFilteredMonthColumns();
      
      // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞„Åï„Çå„ÅüÊúàÂàó„ÅÆ„Åø„ÇíËøΩÂä†
      filteredMonthColumns.forEach((monthCol, index) => {
        const columnDef = {
          title: monthCol.label,
          field: `month_${monthCol.year}_${monthCol.month}`,
          width: 90,
          minWidth: 80,
          maxWidth: 110,
          hozAlign: "right",
          formatter: (cell) => {
            const monthlyBudget = cell.getValue();
            const rowData = cell.getRow().getData();
            
            // ÁèæÂú®„ÅÆÂπ¥Êúà„ÇíÂèñÂæó
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            // ÂØæË±°Êúà„ÅåÈÅéÂéª„ÉªÁèæÂú®„ÉªÊú™Êù•„Åã„ÇíÂà§ÂÆö
            const isCurrentOrPast = 
              monthCol.year < currentYear || 
              (monthCol.year === currentYear && monthCol.month <= currentMonth);
            
            // Ë°®Á§∫Âà∂Âæ°
            const budgetDisplay = monthlyBudget > 0 ? monthlyBudget.toLocaleString() : '-';
            
            // ‰ΩøÁî®È°ç
            let usedDisplay = '-';
            if (isCurrentOrPast) {
              const monthKey = `${monthCol.year}-${monthCol.month.toString().padStart(2, '0')}`;
              const monthlyUsed = rowData.monthlyUsedAmounts?.[monthKey] || 0;
              usedDisplay = monthlyUsed > 0 ? monthlyUsed.toLocaleString() : '0';
            }
            
            // ÊÆãÈ°ç
            let remainingDisplay = '-';
            if (isCurrentOrPast) {
              const monthKey = `${monthCol.year}-${monthCol.month.toString().padStart(2, '0')}`;
              const monthlyUsed = rowData.monthlyUsedAmounts?.[monthKey] || 0;
              const monthlyRemaining = monthlyBudget - monthlyUsed;
              
              if (monthlyBudget > 0 || monthlyUsed > 0) {
                const color = monthlyRemaining < 0 ? 'color: red; font-weight: bold;' : '';
                remainingDisplay = `<span style="${color}">${monthlyRemaining.toLocaleString()}</span>`;
              } else {
                remainingDisplay = '0';
              }
            } else {
              remainingDisplay = '-';
            }
            
            const items = [];
            if (showMonthlyBudget) {
              items.push(`<div style="background-color: #f8fafc; padding: 1px 3px; border-radius: 2px;">${budgetDisplay}</div>`);
            }
            if (showMonthlyUsed) {
              items.push(`<div style="background-color: #eff6ff; padding: 1px 3px; border-radius: 2px;">${usedDisplay}</div>`);
            }
            if (showMonthlyRemaining) {
              items.push(`<div style="background-color: #f0fdf4; padding: 1px 3px; border-radius: 2px;">${remainingDisplay}</div>`);
            }
            
            if (items.length === 0) {
              return '<div style="text-align: center; color: #9ca3af; font-size: 11px;">-</div>';
            }
            
            return `
              <div style="display: flex; flex-direction: column; gap: 1px; font-size: 11px;">
                ${items.join('')}
              </div>
            `;
          }
        };
        monthColumnDefs.push(columnDef);
      });
      // console.log('üîß ÊúàÂàóÊßãÁØâÂÆå‰∫Ü:', monthColumnDefs.length, 'ÂÄã');
    }
    
    // Êìç‰ΩúÂàó„ÇíËøΩÂä†
    const actionColumn = {
      title: "Êìç‰Ωú",
      field: "actions",
      width: 120,
      hozAlign: "center",
      formatter: () => `
        <div style="display: flex; gap: 4px; justify-content: center; align-items: center;">
          <button data-action="edit" style="color: #2563eb; cursor: pointer; padding: 2px 8px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9; font-size: 11px;">Á∑®ÈõÜ</button>
          <button data-action="delete" style="color: #dc2626; cursor: pointer; padding: 2px 8px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9; font-size: 11px;">ÂâäÈô§</button>
        </div>
      `,
      cellClick: (e, cell) => {
        const target = e.target as HTMLElement;
        const action = target.getAttribute('data-action');
        const rowData = cell.getRow().getData();
        const item = budgetItems.find(i => i.id === rowData.id);
        
        if (item) {
          if (action === 'edit') {
            dispatch('edit', { item });
          } else if (action === 'delete') {
            dispatch('delete', { item });
          }
        }
      }
    };

    // ÊúÄÁµÇÁöÑ„Å™ÂàóÂÆöÁæ©„ÇíÊßãÁØâ
    columns = [...baseColumns, ...monthColumnDefs, actionColumn];
    // console.log('üîß ÊúÄÁµÇÁöÑ„Å™columnsË®≠ÂÆöÂÆå‰∫Ü:', {
    // totalColumnsLength: columns.length
    // });
  }

  function prepareTableData() {
    tableData = budgetItems.map(item => {
      const remaining = (item.budgetedAmount || 0) - (item.usedAmount || 0);
      const baseData = {
        ...item,
        usedAmount: item.usedAmount || 0,
        budgetedAmount: item.budgetedAmount || 0,
        remainingAmount: remaining,
        actions: ''
      };
      
      // ÊúàÂà•„Éá„Éº„Çø„ÇíËøΩÂä†
      if (monthColumns && monthColumns.length > 0) {
        const monthlyData = monthColumns.reduce((acc, monthCol) => {
          const monthAmount = getMonthlyAmount(item, monthCol.year, monthCol.month);
          const fieldKey = `month_${monthCol.year}_${monthCol.month}`;
          acc[fieldKey] = monthAmount;
          return acc;
        }, {});
        Object.assign(baseData, monthlyData);
      }
      
      return baseData;
    });
  }

  function initializeTable() {
    if (isTableInitializing) {
      // console.log('Table initialization already in progress, skipping');
      return;
    }

    isTableInitializing = true;
    
    if (table) {
      table.destroy();
      table = null;
    }
    
    if (!tableElement) {
      console.warn('Table element not found');
      isTableInitializing = false;
      return;
    }

    if (columns.length === 0) {
      console.warn('No columns defined for table');
      isTableInitializing = false;
      return;
    }
    
    try {
      const initColumns = baseColumns.length > 0 ? baseColumns : columns;
      
    // console.log('üèóÔ∏è initializeTable: „ÉÜ„Éº„Éñ„É´‰ΩúÊàêÈñãÂßã', {
    // columnsLength: initColumns.length,
    // tableDataLength: tableData.length
    // });
      
      table = new Tabulator(tableElement, {
        data: tableData,
        columns: initColumns,
        layout: "fitDataFill",
        responsiveLayout: false,
        height: "calc(100vh - 200px)",
        pagination: "local",
        paginationSize: window.innerHeight > 900 ? 150 : 100,
        paginationSizeSelector: [50, 100, 150, 200],
        movableColumns: true,
        resizableRows: false,
        resizableColumns: true,
        selectable: 1,
        scrollToColumnPosition: "left",
        scrollToColumnVisibility: "visible",
        reactiveData: true,
        virtualDomVert: true
      });

      table.on("tableBuilt", function() {
        // console.log("üìä Tabulator table built successfully");
        isTableInitializing = false;
        isTableUpdating = false;
      });

      table.on("tableBuiltFailed", function(error) {
        console.error("Tabulator table build failed:", error);
        isTableInitializing = false;
        isTableUpdating = false;
      });

    } catch (error) {
      console.error('Error initializing Tabulator table:', error);
      isTableInitializing = false;
      isTableUpdating = false;
      table = null;
    }
  }

  function updateTable() {
    if (!tableElement) {
      console.warn('Table element not available for update');
      return;
    }

    if (isTableInitializing) {
      // console.log('Table is initializing, deferring update');
      setTimeout(() => updateTable(), 200);
      return;
    }

    if (table && table.initialized) {
      try {
        const completeColumns = columns;
        
    // console.log('üîß updateTable: ÂÆåÂÖ®„Å™ÂàóÂÆöÁæ©„ÅßÊõ¥Êñ∞ÂÆüË°å', {
    // totalColumns: completeColumns.length
    // });
        
        table.setColumns(completeColumns);
        table.setData(tableData);
        table.redraw(true);
        
      } catch (error) {
        console.error('Error updating table:', error);
        initializeTable();
      }
    } else {
      initializeTable();
    }
  }

  function handleTableUpdate() {
    // console.log('üîß handleTableUpdate Âëº„Å≥Âá∫„Åó:', {
    // tableElement: !!tableElement,
    // budgetItems: budgetItems.length,
    // monthColumns: monthColumns.length
    // });
    
    if (!tableElement) {
      // console.log('‚ö†Ô∏è tableElement „ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
      return;
    }
    
    if (budgetItems.length === 0) {
      // console.log('‚ö†Ô∏è ‰∫àÁÆóÈ†ÖÁõÆ„Åå0‰ª∂„ÅÆ„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó');
      return;
    }
    
    isTableUpdating = true;
    
    try {
      initializeTableColumns();
      prepareTableData();
      updateTable();
      // console.log('üîÑ „ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞ÂÆå‰∫Ü');
    } catch (error) {
      console.error('„ÉÜ„Éº„Éñ„É´Êõ¥Êñ∞„Ç®„É©„Éº:', error);
    } finally {
      isTableUpdating = false;
    }
  }

  function handleDisplaySettingsChange(currentSettings: any) {
    // console.log('üìä Ë°®Á§∫Ë®≠ÂÆöÂ§âÊõ¥Ê§úÂá∫:', currentSettings);
    
    const isFilterChange = 
      currentSettings.monthFilterStartYear !== lastDisplaySettings.monthFilterStartYear ||
      currentSettings.monthFilterStartMonth !== lastDisplaySettings.monthFilterStartMonth ||
      currentSettings.monthFilterEndYear !== lastDisplaySettings.monthFilterEndYear ||
      currentSettings.monthFilterEndMonth !== lastDisplaySettings.monthFilterEndMonth;
    
    lastDisplaySettings = { ...currentSettings };
    
    if (isFilterChange) {
      // console.log('üîß ÊúàÁµû„ÇäËæº„ÅøÂ§âÊõ¥„ÅÆ„Åü„ÇÅ„ÉÜ„Éº„Éñ„É´ÂÜçÊßãÁØâ');
      if (table) {
        table.destroy();
        table = null;
      }
      isTableUpdating = false;
      setTimeout(() => {
        // console.log('üîß Áµû„ÇäËæº„ÅøÂ§âÊõ¥„Å´„Çà„ÇãÂÜçÊßãÁØâÈñãÂßã');
        handleTableUpdate();
      }, 200);
    } else {
      // console.log('üîß Ë°®Á§∫È†ÖÁõÆÂ§âÊõ¥„ÅÆ„Åü„ÇÅÂÜçÊèèÁîª');
      if (table) {
        table.redraw(true);
      }
    }
  }

  // Lifecycle
  onMount(() => {
    // console.log('BudgetItemTable mounted');
  });

  onDestroy(() => {
    if (table) {
      table.destroy();
      table = null;
    }
  });
</script>

<div bind:this={tableElement} class="budget-item-table"></div>

<style>
  .budget-item-table {
    width: 100%;
    min-height: 400px;
  }
</style>